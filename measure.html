layout: null
permalink: /measure/
---
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…ØªØ± Ø§Ù„Ø°ÙƒÙŠ - Ù‚ÙŠØ§Ø³ Ø¯Ù‚ÙŠÙ‚ Ù…Ø¹ Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #000;
            color: white;
            overflow: hidden;
        }

        #app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* Canvas Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        #camera-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Canvas Ù„Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .ui-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            left: 20px;
            z-index: 3;
            pointer-events: none;
        }

        .ui-panel * {
            pointer-events: auto;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .control-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(45deg, #d4af37, #ffd700);
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #333;
            color: white;
            border: 2px solid #d4af37;
        }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ */
        .measurement-info {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #00ff00;
            display: none;
        }

        .measurement-info.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .distance-display {
            text-align: center;
            margin: 20px 0;
        }

        .distance-value {
            font-size: 3rem;
            font-weight: bold;
            color: #00ff00;
        }

        .distance-unit {
            color: #aaa;
            margin-top: 5px;
        }

        .point-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ù‡Ø¯Ù */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            z-index: 3;
        }

        .crosshair-inner {
            width: 100%;
            height: 100%;
            border: 2px solid #00ff00;
            border-radius: 50%;
            position: relative;
        }

        .crosshair-inner::before,
        .crosshair-inner::after {
            content: '';
            position: absolute;
            background: #00ff00;
        }

        .crosshair-inner::before {
            width: 100%;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .crosshair-inner::after {
            width: 2px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #aaa;
            max-width: 300px;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #d4af37;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ø±Ø¤ÙˆØ³ Ø§Ù„Ù†Ù‚Ø§Ø· */
        .point-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #d4af37;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 4;
            pointer-events: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Ø®Ø· Ø§Ù„Ù‚ÙŠØ§Ø³ */
        .measurement-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #d4af37, #ffd700);
            z-index: 4;
            pointer-events: none;
            transform-origin: 0 0;
        }

        /* ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        .instructions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 0.9rem;
        }

        .instructions ol {
            padding-right: 20px;
            margin: 10px 0;
        }

        .instructions li {
            margin: 5px 0;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Canvas Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <canvas id="camera-canvas"></canvas>
        
        <!-- Canvas Ù„Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ -->
        <canvas id="three-canvas"></canvas>
        
        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ù‡Ø¯Ù -->
        <div class="crosshair">
            <div class="crosshair-inner"></div>
        </div>
        
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="ui-panel">
            <div class="header">
                <h1>ğŸ“ Ø§Ù„Ù…ØªØ± Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
                <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</div>
            </div>
            
            <div class="control-bar">
                <button id="calibrate-btn" class="btn secondary" onclick="calibrate()">
                    <span>ğŸ¯</span> Ù…Ø¹Ø§ÙŠØ±Ø©
                </button>
                <button id="measure-btn" class="btn" onclick="toggleMeasurement()">
                    <span>ğŸ“</span> Ø¨Ø¯Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³
                </button>
                <button id="clear-btn" class="btn secondary" onclick="clearAll()" disabled>
                    <span>ğŸ—‘ï¸</span> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                </button>
            </div>
            
            <div id="measurement-panel" class="measurement-info">
                <div class="distance-display">
                    <div id="distance-value" class="distance-value">0.00</div>
                    <div class="distance-unit">Ù…ØªØ±</div>
                </div>
                <div class="point-info">
                    <div>Ø§Ù„Ù†Ù‚Ø·Ø© 1: <span id="point1-coords">(0, 0)</span></div>
                    <div>Ø§Ù„Ù†Ù‚Ø·Ø© 2: <span id="point2-coords">(0, 0)</span></div>
                </div>
                <div class="point-info">
                    <div>Ø§Ù„Ø²Ø§ÙˆÙŠØ©: <span id="angle">0Â°</span></div>
                    <div>Ø§Ù„Ø¯Ù‚Ø©: <span id="accuracy">Â± 0.01 Ù…</span></div>
                </div>
            </div>
        </div>
        
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-panel" id="stats-panel">
            <div>Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: <span id="resolution">640x480</span></div>
            <div>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±: <span id="fps">0</span> fps</div>
            <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ø´Ø·Ø©: <span id="active-points">0</span></div>
            <div>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="pose-status">ØºÙŠØ± Ù†Ø´Ø·</span></div>
        </div>
        
        <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
        <div class="instructions">
            <h3>ğŸ“ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h3>
            <ol>
                <li>Ø§Ø¶ØºØ· "Ù…Ø¹Ø§ÙŠØ±Ø©" Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¯Ù‚Ø©</li>
                <li>Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³"</li>
                <li>ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø¤Ø´Ø± Ù†Ø­Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ø¶ØºØ·</li>
                <li>Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø¶ØºØ·</li>
                <li>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø®Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
            </ol>
        </div>
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="loading-screen" id="loading-screen">
            <div class="spinner"></div>
            <h3 style="color:#d4af37;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</h3>
            <p id="loading-text">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù</p>
        </div>
    </div>

    <script>
        // ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ====================
        let cameraStream = null;
        let videoElement = null;
        let cameraCanvas = null;
        let cameraCtx = null;
        let threeCanvas = null;
        let threeScene = null;
        let threeCamera = null;
        let threeRenderer = null;
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let isMeasuring = false;
        let isCalibrated = false;
        let calibrationFactor = 1.0;
        let measurementPoints = [];
        let measurementLines = [];
        let activeLine = null;
        
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        let frameCount = 0;
        let lastTime = Date.now();
        let fps = 0;
        
        // Ø¹Ù†Ø§ØµØ± DOM
        const statusElement = document.getElementById('status');
        const measureBtn = document.getElementById('measure-btn');
        const clearBtn = document.getElementById('clear-btn');
        const measurementPanel = document.getElementById('measurement-panel');
        const distanceValue = document.getElementById('distance-value');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        
        // ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        async function initApp() {
            try {
                loadingText.textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
                
                // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                await initCamera();
                
                // 2. ØªÙ‡ÙŠØ¦Ø© Three.js
                initThreeJS();
                
                // 3. ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³
                initMeasurementSystem();
                
                // 4. Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙŠÙŠØ±
                startRendering();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    statusElement.textContent = 'âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ù‚ÙŠØ§Ø³';
                }, 2000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                loadingText.textContent = `Ø®Ø·Ø£: ${error.message}`;
            }
        }
        
        // ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====================
        async function initCamera() {
            try {
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ÙÙŠØ¯ÙŠÙˆ Ù…Ø®ÙÙŠ
                videoElement = document.createElement('video');
                videoElement.srcObject = cameraStream;
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                
                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.width = videoElement.videoWidth;
                        videoElement.height = videoElement.videoHeight;
                        resolve();
                    };
                });
                
                // ØªÙ‡ÙŠØ¦Ø© canvas Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                cameraCanvas = document.getElementById('camera-canvas');
                cameraCtx = cameraCanvas.getContext('2d');
                cameraCanvas.width = videoElement.videoWidth;
                cameraCanvas.height = videoElement.videoHeight;
                
                console.log('âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                
            } catch (error) {
                throw new Error(`ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ${error.message}`);
            }
        }
        
        // ==================== ØªÙ‡ÙŠØ¦Ø© Three.js ====================
        function initThreeJS() {
            // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ canvas
            threeCanvas = document.getElementById('three-canvas');
            
            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯
            threeScene = new THREE.Scene();
            
            // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            threeCamera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            threeCamera.position.z = 5;
            
            // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ Renderer
            threeRenderer = new THREE.WebGLRenderer({
                canvas: threeCanvas,
                alpha: true,
                antialias: true
            });
            threeRenderer.setSize(window.innerWidth, window.innerHeight);
            threeRenderer.setPixelRatio(window.devicePixelRatio);
            
            // 5. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            threeScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 1);
            threeScene.add(directionalLight);
            
            console.log('âœ… Three.js Ø¬Ø§Ù‡Ø²');
        }
        
        // ==================== ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ ====================
        function initMeasurementSystem() {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            window.addEventListener('resize', onWindowResize);
            threeCanvas.addEventListener('click', handleCanvasClick);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ·
            setupLineRendering();
            
            // Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø§Ù„ØªØµÙŠÙŠØ±
            requestAnimationFrame(updateStats);
        }
        
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ· ====================
        function setupLineRendering() {
            // Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ù…
            const pointMaterial = new THREE.MeshBasicMaterial({ color: 0xd4af37 });
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0x00ff00,
                linewidth: 3
            });
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
            window.measurementMaterials = {
                point: pointMaterial,
                line: lineMaterial
            };
        }
        
        // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù‚Ø±Ø§Øª Canvas ====================
        function handleCanvasClick(event) {
            if (!isMeasuring) return;
            
            // Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø© ÙÙŠ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            const rect = threeCanvas.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù‚ÙŠØ§Ø³
            addMeasurementPoint(x, y);
        }
        
        // ==================== Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù‚ÙŠØ§Ø³ ====================
        function addMeasurementPoint(x, y) {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù„Ù„Ù†Ù‚Ø·Ø©
            const pointGeometry = new THREE.SphereGeometry(0.05, 32, 32);
            const pointMaterial = window.measurementMaterials.point;
            const pointMesh = new THREE.Mesh(pointGeometry, pointMaterial);
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            const vector = new THREE.Vector3(x, y, 0.5);
            vector.unproject(threeCamera);
            
            const dir = vector.sub(threeCamera.position).normalize();
            const distance = -threeCamera.position.z / dir.z;
            const pos = threeCamera.position.clone().add(dir.multiplyScalar(distance));
            
            pointMesh.position.copy(pos);
            threeScene.add(pointMesh);
            
            // Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø·Ø©
            measurementPoints.push({
                mesh: pointMesh,
                position: pos.clone(),
                screenX: x,
                screenY: y
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updatePointDisplays();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ù†Ù‚Ø·ØªØ§Ù† Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ Ø±Ø³Ù… Ø®Ø·
            if (measurementPoints.length >= 2) {
                drawMeasurementLine();
            }
            
            // ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ù…Ø³Ø­
            clearBtn.disabled = false;
            
            console.log(`ğŸ“Œ Ù†Ù‚Ø·Ø© ${measurementPoints.length} Ù…Ø¶Ø§ÙÙ‡`, pos);
        }
        
        // ==================== Ø±Ø³Ù… Ø®Ø· Ø§Ù„Ù‚ÙŠØ§Ø³ ====================
        function drawMeasurementLine() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
            if (activeLine) {
                threeScene.remove(activeLine);
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† Ø§Ù„Ø£Ø®ÙŠØ±ØªÙŠÙ†
            const point1 = measurementPoints[measurementPoints.length - 2];
            const point2 = measurementPoints[measurementPoints.length - 1];
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø®Ø·
            const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                point1.position,
                point2.position
            ]);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø·
            const lineMaterial = window.measurementMaterials.line;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·
            activeLine = new THREE.Line(lineGeometry, lineMaterial);
            threeScene.add(activeLine);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
            calculateDistance(point1, point2);
            
            // Ø­ÙØ¸ Ø§Ù„Ø®Ø·
            measurementLines.push(activeLine);
        }
        
        // ==================== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ====================
        function calculateDistance(point1, point2) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
            const directDistance = point1.position.distanceTo(point2.position);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
            const calibratedDistance = directDistance * calibrationFactor;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            distanceValue.textContent = calibratedDistance.toFixed(2);
            measurementPanel.classList.add('show');
            
            // ØªØ­Ø¯ÙŠØ« Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø§Ø·
            document.getElementById('point1-coords').textContent = 
                `(${point1.position.x.toFixed(2)}, ${point1.position.y.toFixed(2)})`;
            document.getElementById('point2-coords').textContent = 
                `(${point2.position.x.toFixed(2)}, ${point2.position.y.toFixed(2)})`;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ©
            const dx = point2.position.x - point1.position.x;
            const dy = point2.position.y - point1.position.y;
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            document.getElementById('angle').textContent = `${Math.abs(angle).toFixed(1)}Â°`;
            
            console.log(`ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${calibratedDistance.toFixed(2)} Ù…ØªØ±`);
        }
        
        // ==================== Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ====================
        function calibrate() {
            const knownDistance = prompt('Ø£Ø¯Ø®Ù„ Ø·ÙˆÙ„ Ù…Ø¹Ø±ÙˆÙ Ø¨Ø§Ù„Ù…ØªØ± (Ù…Ø«Ù„Ø§Ù‹: 1 Ù…ØªØ±):', '1');
            
            if (knownDistance && !isNaN(parseFloat(knownDistance))) {
                const distance = parseFloat(knownDistance);
                
                if (measurementPoints.length >= 2) {
                    const point1 = measurementPoints[measurementPoints.length - 2];
                    const point2 = measurementPoints[measurementPoints.length - 1];
                    const measuredDistance = point1.position.distanceTo(point2.position);
                    
                    calibrationFactor = distance / measuredDistance;
                    isCalibrated = true;
                    
                    alert(`âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­: ${calibrationFactor.toFixed(4)}`);
                    statusElement.textContent = `Ù…Ø¹Ø§ÙŠØ± (Ø¹Ø§Ù…Ù„: ${calibrationFactor.toFixed(2)})`;
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    calculateDistance(point1, point2);
                } else {
                    alert('âš ï¸ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù†Ù‚Ø·ØªÙŠÙ† Ù„Ù„Ù…Ø¹Ø§ÙŠØ±Ø©');
                }
            }
        }
        
        // ==================== ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ ====================
        function toggleMeasurement() {
            isMeasuring = !isMeasuring;
            
            if (isMeasuring) {
                measureBtn.innerHTML = '<span>â¸ï¸</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚ÙŠØ§Ø³';
                statusElement.textContent = 'ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù†Ø´Ø· - Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·';
            } else {
                measureBtn.innerHTML = '<span>ğŸ“</span> Ø¨Ø¯Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³';
                statusElement.textContent = 'â¸ï¸ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù…ØªÙˆÙ‚Ù';
            }
        }
        
        // ==================== Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ ====================
        function clearAll() {
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·
            measurementPoints.forEach(point => {
                threeScene.remove(point.mesh);
                point.mesh.geometry.dispose();
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ·
            measurementLines.forEach(line => {
                threeScene.remove(line);
                line.geometry.dispose();
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            measurementPoints = [];
            measurementLines = [];
            activeLine = null;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            measurementPanel.classList.remove('show');
            clearBtn.disabled = true;
            
            console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª');
        }
        
        // ==================== Ø§Ù„ØªØµÙŠÙŠØ± ====================
        function startRendering() {
            function render() {
                // Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ canvas Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                if (videoElement && cameraCtx) {
                    cameraCtx.drawImage(videoElement, 0, 0, cameraCanvas.width, cameraCanvas.height);
                }
                
                // ØªØµÙŠÙŠØ± Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                threeRenderer.render(threeScene, threeCamera);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                updateStats();
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØªØµÙŠÙŠØ±
                requestAnimationFrame(render);
            }
            
            render();
        }
        
        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
        function updateStats() {
            frameCount++;
            const currentTime = Date.now();
            
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('fps').textContent = fps;
                document.getElementById('active-points').textContent = measurementPoints.length;
                document.getElementById('resolution').textContent = 
                    `${cameraCanvas.width}x${cameraCanvas.height}`;
            }
        }
        
        // ==================== ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© ====================
        function onWindowResize() {
            if (threeCamera && threeRenderer) {
                threeCamera.aspect = window.innerWidth / window.innerHeight;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            if (cameraCanvas) {
                cameraCanvas.width = window.innerWidth;
                cameraCanvas.height = window.innerHeight;
            }
        }
        
        // ==================== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ====================
        function updatePointDisplays() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ù†ØµÙŠØ© Ù„Ù„Ù†Ù‚Ø§Ø·
            // Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        }
        
        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.calibrate = calibrate;
        window.toggleMeasurement = toggleMeasurement;
        window.clearAll = clearAll;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
        
    </script>
</body>
</html>
      
